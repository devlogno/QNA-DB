{% extends "layout.html" %}
{% from 'partials/_macros.html' import render_question_card %}

{% block title %}Quiz in Progress{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with Timer -->
    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-white">Quiz Session</h1>
        <div class="text-right">
            <p class="text-gray-400">Time Remaining</p>
            <p id="timer" class="text-2xl font-bold text-red-400">{{ exam.settings.time_limit_minutes }}:00</p>
        </div>
    </div>

    <!-- Questions Container -->
    <div id="quiz-container" class="space-y-8">
        {% for question in questions %}
            {{ render_question_card(question, loop) }}
        {% endfor %}
    </div>

    <!-- Submit Button -->
    <div class="mt-8">
        <button id="submit-quiz-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
            Submit Quiz
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const timerDisplay = document.getElementById('timer');
    const submitBtn = document.getElementById('submit-quiz-btn');
    const quizContainer = document.getElementById('quiz-container');
    const timeLimitMinutes = {{ exam.settings.time_limit_minutes }};
    let timeLeft = timeLimitMinutes * 60;
    let startTime = Date.now();

    const timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert("Time's up! Submitting your answers.");
            submitQuiz();
        }
    }, 1000);

    const submitQuiz = async () => {
        clearInterval(timerInterval);
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const answers = {};
        if ("{{ exam.settings.question_type }}" === "MCQ") {
            document.querySelectorAll('.mcq-option-btn:checked').forEach(input => {
                answers[input.dataset.questionId] = input.dataset.option;
            });
        }
        
        const timeTaken = Math.round((Date.now() - startTime) / 1000);

        try {
            const response = await fetch("{{ url_for('quiz.submit_quiz', session_id=exam.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answers, time_taken: timeTaken })
            });
            const data = await response.json();
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('An error occurred while submitting.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Quiz';
            }
        } catch (error) {
            console.error('Submission error:', error);
        }
    };

    submitBtn.addEventListener('click', submitQuiz);

    // Modify question card behavior for quiz mode
    quizContainer.addEventListener('click', (event) => {
        const mcqOption = event.target.closest('.mcq-option-btn');
        if (mcqOption) {
            const questionId = mcqOption.dataset.questionId;
            // Un-style other buttons for the same question
            document.querySelectorAll(`.mcq-option-btn[data-question-id="${questionId}"]`).forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-black', 'text-white');
            });
            // Style the selected button
            mcqOption.classList.add('bg-blue-600', 'text-white');
            mcqOption.classList.remove('bg-black');
            
            // Create a hidden radio button to hold the state
            let radio = document.getElementById(`radio-${questionId}-${mcqOption.dataset.option}`);
            if(!radio) {
                 document.querySelectorAll(`input[name="q_${questionId}"]`).forEach(r => r.remove());
                 radio = document.createElement('input');
                 radio.type = 'radio';
                 radio.name = `q_${questionId}`;
                 radio.id = `radio-${questionId}-${mcqOption.dataset.option}`;
                 radio.dataset.questionId = questionId;
                 radio.dataset.option = mcqOption.dataset.option;
                 radio.className = 'mcq-option-btn'; // Use same class to find it later
                 radio.style.display = 'none';
                 quizContainer.appendChild(radio);
            }
            radio.checked = true;
        }
    });
});
</script>
{% endblock %}
