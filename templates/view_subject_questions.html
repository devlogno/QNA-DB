{% extends "layout.html" %}
{% from 'partials/_macros.html' import render_question_card %}

{% block title %}{{ question_type }} for {{ subject.name }} ({{ year }}){% endblock %}

{% block content %}
<nav class="text-sm font-medium mb-6" aria-label="Breadcrumb">
  <ol class="list-none p-0 inline-flex flex-wrap">
    <li class="flex items-center"><a href="{{ url_for('routes.browse_levels') }}" class="text-gray-400 hover:text-white">Browse</a></li>
    <li class="flex items-center"><svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg><a href="{{ url_for('routes.browse_streams', level_name=subject.board.stream.level.name) }}" class="text-gray-400 hover:text-white">{{ subject.board.stream.level.name }}</a></li>
    <li class="flex items-center"><svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg><a href="{{ url_for('routes.browse_boards_by_name', level_name=subject.board.stream.level.name, stream_name=subject.board.stream.name) }}" class="text-gray-400 hover:text-white">{{ subject.board.stream.name }}</a></li>
    <li class="flex items-center"><svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg><a href="{{ url_for('routes.browse_years', level_name=subject.board.stream.level.name, stream_name=subject.board.stream.name, board_name=subject.board.name) }}" class="text-gray-400 hover:text-white">{{ subject.board.name }}</a></li>
    <li class="flex items-center"><svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg><a href="{{ url_for('routes.browse_subjects_by_year', level_name=subject.board.stream.level.name, stream_name=subject.board.stream.name, board_name=subject.board.name, year=year) }}" class="text-gray-400 hover:text-white">{{ year }}</a></li>
    <li class="flex items-center"><svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg><span class="text-white">{{ subject.name }}</span></li>
  </ol>
</nav>

<h1 class="text-3xl font-bold text-gray-100 mb-6">
    {{ question_type }} Questions for {{ subject.name }} ({{ year }})
</h1>

<div id="questions-container" class="space-y-8">
    {% if questions %}
        {% for question in questions %}
            {{ render_question_card(question, loop, is_premium, 0) }}
        {% endfor %}
    {% else %}
        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 text-center">
            <p class="text-xl font-semibold text-gray-200">Coming Soon!</p>
            <p class="text-gray-400 mt-2">No {{ question_type }} questions are available for this section yet. Please check back later!</p>
        </div>
    {% endif %}
</div>

<div id="loading-spinner" class="text-center py-8 {% if not pagination.has_next %}hidden{% endif %}">
    <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-gray-400 mt-2">Loading more questions...</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let currentPage = {{ pagination.page }};
    let hasNextPage = {{ pagination.has_next | tojson }};
    let isLoading = false;
    const loadingSpinner = document.getElementById('loading-spinner');
    const questionsContainer = document.getElementById('questions-container');
    const mainContent = document.querySelector('main');

    const loadMoreQuestions = async () => {
        if (!hasNextPage || isLoading) return;

        isLoading = true;
        currentPage++;
        loadingSpinner.classList.remove('hidden');

        try {
            const response = await fetch(`/api/more_questions/{{ subject.id }}/{{ question_type }}/{{ year }}?page=${currentPage}`);
            const data = await response.json();

            if (data.html) {
                questionsContainer.insertAdjacentHTML('beforeend', data.html);
                if (window.MathJax) {
                    window.MathJax.typesetPromise();
                }
            }
            hasNextPage = data.has_next;
        } catch (error) {
            console.error('Error loading more questions:', error);
        } finally {
            isLoading = false;
            if (!hasNextPage) {
                loadingSpinner.classList.add('hidden');
            }
        }
    };

    const handleScroll = () => {
        const { scrollTop, scrollHeight, clientHeight } = mainContent;
        if (scrollTop + clientHeight >= scrollHeight - 150) {
            loadMoreQuestions();
        }
    };

    if (mainContent) {
        mainContent.addEventListener('scroll', handleScroll);
    }
});
</script>
{% endblock %}