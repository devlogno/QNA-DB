{% extends "layout.html" %}

{% block title %}Performance Analytics{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #study-calendar { display: grid; grid-template-columns: repeat(53, 1fr); gap: 2px; }
    .day-cell { width: 12px; height: 12px; background-color: #2d3748; border-radius: 2px; }
    .day-cell[data-level='1'] { background-color: #2c5282; }
    .day-cell[data-level='2'] { background-color: #2a69ac; }
    .day-cell[data-level='3'] { background-color: #3182ce; }
    .day-cell[data-level='4'] { background-color: #4299e1; }
</style>

<h1 class="text-3xl font-bold text-gray-100 mb-6">Your Performance Analytics</h1>

<!-- Summary Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h2 class="text-xl font-semibold text-gray-200 mb-3">Total Exams Taken</h2>
        <p class="text-3xl font-bold text-blue-400">{{ total_exams }}</p>
    </div>
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h2 class="text-xl font-semibold text-gray-200 mb-3">Total Questions Answered</h2>
        <p class="text-3xl font-bold text-green-400">{{ total_questions_answered }}</p>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h2 class="text-xl font-semibold text-gray-200 mb-4">Accuracy by Subject</h2>
        <canvas id="accuracyChart"></canvas>
    </div>
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h2 class="text-xl font-semibold text-gray-200 mb-4">Quiz Score History</h2>
        <canvas id="scoreHistoryChart"></canvas>
    </div>
</div>

<!-- Study Calendar -->
<div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
    <h2 class="text-xl font-semibold text-gray-200 mb-4">Study Activity (Last Year)</h2>
    <div id="study-calendar" class="w-full overflow-x-auto"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Accuracy Chart
    const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
    new Chart(accuracyCtx, {
        type: 'bar',
        data: {
            labels: {{ accuracy_by_subject|map(attribute=0)|list|tojson|safe }},
            datasets: [{
                label: 'Accuracy %',
                data: {{ accuracy_by_subject|map(attribute=1)|list|tojson|safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Score History Chart
    const scoreHistoryCtx = document.getElementById('scoreHistoryChart').getContext('2d');
    new Chart(scoreHistoryCtx, {
        type: 'line',
        data: {
            // --- FIXED: Use the pre-formatted variables from the backend ---
            labels: {{ score_history_labels|tojson|safe }},
            datasets: [{
                label: 'Accuracy %',
                data: {{ score_history_data|tojson|safe }},
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Study Calendar
    const calendarContainer = document.getElementById('study-calendar');
    fetch('/analytics/study-calendar-data')
        .then(response => response.json())
        .then(data => {
            const today = new Date();
            const startDate = new Date();
            startDate.setDate(today.getDate() - 365);

            for (let i = 0; i < 366; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                
                const cell = document.createElement('div');
                cell.classList.add('day-cell');
                
                if (data[dateString]) {
                    const seconds = data[dateString];
                    let level = 1;
                    if (seconds > 3600) level = 4; // > 1 hour
                    else if (seconds > 1800) level = 3; // > 30 mins
                    else if (seconds > 600) level = 2;  // > 10 mins
                    cell.dataset.level = level;
                    cell.title = `${dateString}: ${Math.round(seconds / 60)} minutes`;
                }
                calendarContainer.appendChild(cell);
            }
        });
});
</script>

{% endblock %}
