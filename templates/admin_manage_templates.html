{% extends "layout.html" %}

{% block title %}Manage Subject Templates - Admin Panel{% endblock %}

{% block content %}
<style>
    .template-column {
        min-width: 280px;
        max-width: 320px;
        height: 75vh;
        overflow-y: auto;
    }
    .template-item {
        cursor: pointer;
    }
    .template-item.selected {
        background-color: #1f2937; /* gray-800 */
        border-left-color: var(--neon-blue);
    }
    .action-btn {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }
    .template-item:hover .action-btn {
        opacity: 1;
    }
</style>

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-white">Manage Subject Templates</h1>
    <a href="{{ url_for('admin.manage_categories') }}" class="px-4 py-2 text-base font-semibold text-white bg-dark-card rounded-lg border border-dark-border hover:bg-dark-border transition-colors">Back to Live Categories</a>
</div>
<p class="text-gray-400 mb-6">Create reusable subject structures here. You can then import these templates into any board in the main category manager.</p>

<div class="flex space-x-4 overflow-x-auto pb-4">
    <!-- Subject Templates Column -->
    <div class="bg-dark-card p-4 rounded-lg border border-dark-border template-column">
        <h2 class="text-xl font-semibold text-white mb-4">Subject Templates</h2>
        <ul id="subjects-list" class="space-y-2"></ul>
        <div class="mt-4">
            <input type="text" id="new-subject-name" placeholder="New Template Name (e.g., HSC Physics)" class="w-full bg-dark-bg text-white p-2 rounded-lg border border-dark-border">
            <button onclick="addItem('subjects')" class="w-full mt-2 bg-blue-600 hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Add Template</button>
        </div>
    </div>

    <!-- Chapters Column -->
    <div id="chapters-col" class="bg-dark-card p-4 rounded-lg border border-dark-border template-column hidden">
        <h2 class="text-xl font-semibold text-white mb-4">Chapters</h2>
        <ul id="chapters-list" class="space-y-2"></ul>
        <div class="mt-4">
            <input type="text" id="new-chapter-name" placeholder="New Chapter Name" class="w-full bg-dark-bg text-white p-2 rounded-lg border border-dark-border">
            <button onclick="addItem('chapters')" class="w-full mt-2 bg-blue-600 hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Add Chapter</button>
        </div>
    </div>

    <!-- Topics Column -->
    <div id="topics-col" class="bg-dark-card p-4 rounded-lg border border-dark-border template-column hidden">
        <h2 class="text-xl font-semibold text-white mb-4">Topics</h2>
        <ul id="topics-list" class="space-y-2"></ul>
        <div class="mt-4">
            <input type="text" id="new-topic-name" placeholder="New Topic Name" class="w-full bg-dark-bg text-white p-2 rounded-lg border border-dark-border">
            <button onclick="addItem('topics')" class="w-full mt-2 bg-blue-600 hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Add Topic</button>
        </div>
    </div>
</div>

<script>
    const state = {
        subjects: { selectedId: null },
        chapters: { selectedId: null },
        topics: { selectedId: null },
    };
    const categoryPlurals = ['subjects', 'chapters', 'topics'];

    async function apiCall(endpoint, method = 'GET', body = null) {
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'An error occurred');
            }
            if (response.status === 204 || (method === 'DELETE' && response.ok)) return { success: true };
            return response.json();
        } catch (error) {
            alert(`Error: ${error.message}`);
            return null;
        }
    }

    function renderList(category, items) {
        const listElement = document.getElementById(`${category}-list`);
        listElement.innerHTML = !items || items.length === 0 ? '<li class="text-gray-500 italic">No items found.</li>' : '';
        if (items) {
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'template-item flex justify-between items-center p-3 rounded-lg bg-dark-bg hover:bg-dark-border border-l-4 border-transparent';
                li.dataset.id = item.id;
                li.innerHTML = `
                    <span class="flex-grow">${item.name}</span>
                    <div class="flex items-center space-x-2">
                        ${category === 'subjects' ? `<button onclick="event.stopPropagation(); cloneTemplate(${item.id}, '${item.name}')" class="action-btn p-1 text-cyan-400 hover:text-cyan-300" title="Clone"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z"></path><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z"></path></svg></button>` : ''}
                        <button onclick="event.stopPropagation(); editItem('${category}', ${item.id}, '${item.name}')" class="action-btn p-1 text-yellow-400 hover:text-yellow-300" title="Edit"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                        <button onclick="event.stopPropagation(); deleteItem('${category}', ${item.id})" class="action-btn p-1 text-red-500 hover:text-red-400" title="Delete"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                    </div>`;
                li.addEventListener('click', () => handleItemSelect(category, item.id));
                listElement.appendChild(li);
            });
        }
    }

    async function loadData(category, parentId = null) {
        const endpoint = `/admin/api/templates/${category}${parentId ? `?parent_id=${parentId}` : ''}`;
        const items = await apiCall(endpoint);
        if (items) {
            renderList(category, items);
            document.getElementById(`${category}-col`).classList.remove('hidden');
        }
    }

    function resetSubsequentColumns(startIndex) {
        for (let i = startIndex; i < categoryPlurals.length; i++) {
            const category = categoryPlurals[i];
            state[category].selectedId = null;
            document.getElementById(`${category}-col`).classList.add('hidden');
        }
    }

    async function handleItemSelect(category, itemId) {
        if (state[category].selectedId === itemId) return;
        state[category].selectedId = itemId;
        document.querySelectorAll(`#${category}-list .template-item`).forEach(el => el.classList.toggle('selected', el.dataset.id == itemId));
        const currentIndex = categoryPlurals.indexOf(category);
        resetSubsequentColumns(currentIndex + 1);
        const nextCategory = categoryPlurals[currentIndex + 1];
        if (nextCategory) await loadData(nextCategory, itemId);
    }

    async function addItem(category) {
        const nameInput = document.getElementById(`new-${category.slice(0, -1)}-name`);
        const name = nameInput.value.trim();
        if (!name) return alert('Name cannot be empty.');

        const currentIndex = categoryPlurals.indexOf(category);
        const parentCategory = categoryPlurals[currentIndex - 1];
        const parentId = parentCategory ? state[parentCategory].selectedId : null;
        if (parentCategory && !parentId) return alert(`Please select a parent ${parentCategory.slice(0, -1)} first.`);

        const result = await apiCall(`/admin/api/templates/${category}`, 'POST', { name, parent_id: parentId });
        if (result) {
            nameInput.value = '';
            await loadData(category, parentId);
        }
    }

    async function editItem(category, itemId, currentName) {
        const newName = prompt(`Enter new name for "${currentName}":`, currentName);
        if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
            const result = await apiCall(`/admin/api/templates/${category}/${itemId}`, 'PUT', { name: newName.trim() });
            if (result) {
                const currentIndex = categoryPlurals.indexOf(category);
                const parentCategory = categoryPlurals[currentIndex - 1];
                const parentId = parentCategory ? state[parentCategory].selectedId : null;
                await loadData(category, parentId);
            }
        }
    }

    async function deleteItem(category, itemId) {
        if (confirm('Are you sure you want to delete this item and all its children? This cannot be undone.')) {
            const result = await apiCall(`/admin/api/templates/${category}/${itemId}`, 'DELETE');
            if (result) {
                const currentIndex = categoryPlurals.indexOf(category);
                const parentCategory = categoryPlurals[currentIndex - 1];
                const parentId = parentCategory ? state[parentCategory].selectedId : null;
                if (state[category].selectedId === itemId) resetSubsequentColumns(currentIndex);
                await loadData(category, parentId);
            }
        }
    }

    async function cloneTemplate(templateId, templateName) {
        const newName = prompt(`Enter a new name for the cloned template:`, `${templateName} (Copy)`);
        if (newName && newName.trim() !== '') {
            const result = await apiCall(`/admin/api/templates/subjects/${templateId}/clone`, 'POST', { name: newName.trim() });
            if (result) {
                await loadData('subjects');
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => loadData('subjects'));

    window.addItem = addItem;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.cloneTemplate = cloneTemplate;
</script>
{% endblock %}
